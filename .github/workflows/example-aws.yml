name: AWS Terraform Deployment

on:
  pull_request:
    branches: [main]
    paths:
      - 'examples/aws/**'
      - '.github/workflows/example-aws.yml'
      - '.github/workflows/reusable-terraform.yml'
  push:
    branches: [main]
    paths:
      - 'examples/aws/**'
      - '.github/workflows/example-aws.yml'
      - '.github/workflows/reusable-terraform.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  terraform-plan:
    name: Terraform Plan (AWS)
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      cloud_provider: aws
      tf_path: examples/aws
      terraform_operation: plan
      artifact_name: aws-tfplan
      artifact_retention_days: 30
      enable_pr_comment: true
      enable_artifact_upload: true
    secrets:
      aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  terraform-apply:
    name: Terraform Apply (AWS)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      cloud_provider: aws
      tf_path: examples/aws
      terraform_operation: apply
      environment: production
      backend_config: |
        bucket=my-terraform-state-bucket
        key=aws-example.tfstate
        region=us-east-1
    secrets:
      aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
