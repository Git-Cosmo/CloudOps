name: Azure Terraform Deployment

on:
  pull_request:
    branches: [main]
    paths:
      - 'examples/azure/**'
      - '.github/workflows/example-azure.yml'
      - '.github/workflows/reusable-terraform.yml'
  push:
    branches: [main]
    paths:
      - 'examples/azure/**'
      - '.github/workflows/example-azure.yml'
      - '.github/workflows/reusable-terraform.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  terraform-plan:
    name: Terraform Plan (Azure)
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      cloud_provider: azure
      tf_path: examples/azure
      terraform_operation: plan
      artifact_name: azure-tfplan
      artifact_retention_days: 30
      enable_pr_comment: true
      enable_artifact_upload: true
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}

  terraform-apply:
    name: Terraform Apply (Azure)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      cloud_provider: azure
      tf_path: examples/azure
      terraform_operation: apply
      environment: production
      backend_config: |
        resource_group_name=terraform-state-rg
        storage_account_name=tfstateaccount
        container_name=tfstate
        key=azure-example.tfstate
    secrets:
      azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
